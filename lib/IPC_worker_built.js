data:application/javascript,var%20OPEN%20%20%20%20%20%20%20%3D%201%3B%0Avar%20MESSAGE%20%20%20%20%3D%202%3B%0Avar%20BROADCAST%20%20%3D%203%3B%0Avar%20PING%20%20%20%20%20%20%20%3D%204%3B%0Avar%20DISCONNECT%20%3D%205%3B%0A%0Avar%20timeoutSeconds%20%3D%2020%3B%0Avar%20subscribers%20%20%20%20%3D%20%7B%7D%3B%0A%0A%2F**%0A%20*%20%0A%20*%20Destroy%20a%20tab%20subscriber%2C%20and%20tell%20all%20other%20tabs%20that%20this%20tab%20has%20left.%0A%20*%20%0A%20*%20%40param%20%7BString%7D%20id%20%0A%20*%2F%0Afunction%20cleanupSubscriber(id)%20%7B%0A%20%20delete%20subscribers%5Bid%5D%3B%0A%20%20broadcastEvent(%7B%0A%20%20%20%20type%3A%20%20%20%20DISCONNECT%2C%0A%20%20%20%20id%3A%20%20%20%20%20%20id%2C%0A%20%20%20%20current%3A%20Object.keys(subscribers)%0A%20%20%7D)%3B%0A%7D%0A%0A%2F**%0A%20*%20Unsubscribe%20tabs%20that%20have%20not%20pinged%20recently.%0A%20*%2F%0Afunction%20cleanupDeadSubscribers()%20%7B%0A%20%20var%20ok%20%3D%20Object.keys(subscribers)%3B%0A%20%20for(var%20i%20%3D%200%3B%20i%20%3C%20ok.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20var%20k%20%3D%20ok%5Bi%5D%3B%0A%20%20%20%20if%20(subscribers%5Bk%5D.lastPing%20%3C%20(Date.now()%20-%20(timeoutSeconds%20*%201000)))%20%7B%0A%20%20%20%20%20%20cleanupSubscriber(k)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A%0A%2F**%0A%20*%20%0A%20*%20%40param%20%7BString%7D%20sub%20%0A%20*%20%40param%20%7BObject%7D%20ev%20%0A%20*%2F%0Afunction%20sendEvent(sub%2C%20ev)%20%7B%0A%20%20subscribers%5Bsub%5D.port.postMessage(ev)%3B%0A%7D%0A%0A%2F**%0A%20*%20%0A%20*%20%40param%20%7BObject%7D%20ev%20%0A%20*%2F%0Afunction%20broadcastEvent(ev)%20%7B%0A%20%20var%20ok%20%3D%20Object.keys(subscribers)%3B%0A%20%20for(var%20i%20%3D%200%3B%20i%20%3C%20ok.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20var%20k%20%3D%20ok%5Bi%5D%3B%0A%20%20%20%20sendEvent(k%2C%20ev)%3B%0A%20%20%7D%0A%0A%20%20cleanupDeadSubscribers()%3B%0A%7D%0A%0Aself.addEventListener(%22connect%22%2C%20function(e)%20%7B%0A%20%20var%20p%20%3D%20e.ports%5B0%5D%3B%0A%20%20var%20id%20%3D%20%22%22%3B%0A%0A%20%20p.postMessage(%7B%0A%20%20%20%20type%3A%20OPEN%0A%20%20%7D)%3B%0A%0A%20%20p.addEventListener(%22message%22%2C%20function(msg)%20%7B%0A%20%20%20%20switch%20(msg.data.type)%20%7B%0A%20%20%20%20%20%20case%20OPEN%3A%0A%20%20%20%20%20%20subscribers%5Bmsg.data.id%5D%20%3D%20%7B%0A%20%20%20%20%20%20%20%20port%3A%20%20%20%20%20p%2C%0A%20%20%20%20%20%20%20%20lastPing%3A%20Date.now()%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20id%20%3D%20msg.data.id%3B%0A%20%20%20%20%20%20break%3B%0A%0A%20%20%20%20%20%20case%20BROADCAST%3A%0A%20%20%20%20%20%20subscribers%5Bmsg.data.id%5D.lastPing%20%3D%20Date.now()%3B%0A%20%20%20%20%20%20broadcastEvent(%7B%0A%20%20%20%20%20%20%20%20type%3A%20MESSAGE%2C%0A%20%20%20%20%20%20%20%20msg%3A%20%20msg.data.msg%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20break%3B%0A%0A%20%20%20%20%20%20case%20PING%3A%0A%20%20%20%20%20%20subscribers%5Bmsg.data.id%5D.lastPing%20%3D%20Date.now()%3B%0A%20%20%20%20%20%20break%3B%0A%0A%20%20%20%20%20%20case%20DISCONNECT%3A%0A%20%20%20%20%20%20cleanupSubscriber(msg.data.id)%3B%0A%20%20%20%20%20%20break%3B%0A%20%20%20%20%7D%0A%20%20%7D)%3B%0A%0A%20%20p.start()%3B%0A%7D)%3B%0A